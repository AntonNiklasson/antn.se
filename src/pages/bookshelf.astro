---
import { getCollection } from "astro:content";
import FormattedDate from "../components/Date.astro";
import PageLayout from "../layouts/PageLayout.astro";
import { groupBy } from "../utils/group-by";

const raw = await getCollection("books");
const sorted = raw.sort((a, b) => {
	const x = new Date(a.data.dateFinished);
	const y = new Date(b.data.dateFinished);
	return y.valueOf() - x.valueOf();
});

const groupedByYear = groupBy(sorted, (book): number => {
	const finished = new Date(book.data.dateFinished);
	return finished.getFullYear();
});
---

<PageLayout title="Bookshelf">
	<div class="space-y-16">
		<header class="space-y-2">
			<h1 class="text-2xl">Bookshelf</h1>
			<p class="text-gray-600">
				Books I've read, with notes and highlights from my reading.
			</p>
		</header>

		{
			Object.entries(groupedByYear)
				.reverse()
				.map(([year, books]) => {
					return (
						<section class="space-y-4">
							<h3 class="text-md font-bold text-gray-400">{year}</h3>

							<ul class="relative space-y-6 pl-2">
								{books.map((book) => (
									<li>
										<a
											class="block rounded transition hover:opacity-80"
											href={`/books/${book.slug}`}>
											<div class="flex gap-4">
												{book.data.cover && (
													<img
														src={book.data.cover}
														alt={`${book.data.title} cover`}
														class="h-24 w-16 rounded object-cover shadow-sm"
													/>
												)}
												<div class="flex-1 space-y-1">
													<h2 class="text-md text-gray-700">
														{book.data.title}
													</h2>
													<p class="text-sm text-gray-500">
														{book.data.author}
													</p>
													{book.data.rating && (
														<div class="text-sm text-gray-400">
															{"★".repeat(book.data.rating)}
															{"☆".repeat(5 - book.data.rating)}
														</div>
													)}
													<FormattedDate date={book.data.dateFinished} />
												</div>
											</div>
										</a>
									</li>
								))}
							</ul>
						</section>
					);
				})
		}
	</div>
</PageLayout>
